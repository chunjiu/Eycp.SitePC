define(["underscore","jquery","backbone","String","../../../services/event.service","../../publicComponent/timer.component","../../../actions/public/timer.action"],function(e,t,a,r,i,n,o){var l;return{initialize:function(e,t){if(l=this,l.isGetAwardData=!0,e&&"string"==typeof e||console.warn("TimerContainer：_lotteryCode参数不正确, 可能为空，可能不是字符串类型，但是允许为空"),!t||"string"!=typeof t)return void console.error("TimerContainer：_awardType参数不正确");l.lotteryCode=e,l.awardType=t,l.awarding=!1,l.awardWait=0,l.awardWaitSpeed=1e3,l.awardResultWaitSpeed=3e3+1e3*parseInt(Math.floor(5*Math.random()+1)),l.periodText=0,l.isGetJson=l.isReturnJson(l.awardType),o.initialize();new n;l.getAwardTime(l.getAwardTimeCallBack,!0),i.on("isGetAwardData_timerContainer",function(e){void 0!=e&&"boolean"==typeof e?(l.isGetAwardData=e,l.awarding=!1):console.error("isGetAwardData：参数不能为空并且必须是布尔类型！")})},getAwardTimeCallBack:function(e){i.emit("timerCountDown_timerComponent",{completeCallBack:l.completeCallBack,countDowningCallBack:l.countDowningCallBack,awardTimeCount:e}),l.timerAwardData(l.awardWaitSpeed,l.getResultSuccessCallBack)},getAwardTimeCallBack2:function(e){i.emit("timerCountDown_timerComponent",{completeCallBack:l.completeCallBack,countDowningCallBack:l.countDowningCallBack,awardTimeCount:e})},countDowningCallBack:function(e){i.emit("countDowning_timerContainer",e)},completeCallBack:function(e){l.awarding=!0,console.log("开奖中, 还有"+l.awardWait+"秒就更新开奖结果！"),i.emit("complete_timerContainer",e),l.getAwardTime(l.getAwardTimeCallBack2,!1)},getResultSuccessCallBack:function(e){if(l.isGetJson){var t={type:"json",result:e};i.emit("lotteryResults_timerComponent",t)}else{window.setTimeout(function(){o.requestAwardDataForHtml(l.lotteryCode,l.awardType,function(e){var t={type:"html",result:e};i.emit("lotteryResults_timerComponent",t)})},0)}},timerAwardData:function(e,t){var a=window.setInterval(function(){if(l.awarding&&l.isGetAwardData)if(l.awardWait<=0){console.log("=================开始请求服务器拿开奖结果 ========================="),window.clearInterval(a);var e=window.setInterval(function(){o.requestAwardResult(l.lotteryCode,function(a){parseInt(a.period)==l.nextPeriod&&(l.awarding=!1,window.clearInterval(e),l.nextPeriod=l.nextPeriodNow,l.awardWait=l.nextAwardWait,console.log("=================已经拿到最新开奖结果，重新开始倒计 ========================="),t(a),l.timerAwardData(l.awardWaitSpeed,l.getResultSuccessCallBack))})},l.awardResultWaitSpeed)}else l.awardWait--},e)},getAwardTime:function(e,t){var a=this;o.requestAwardTime(a.lotteryCode,function(r){a.awardTimeCount=parseFloat(r.awardTimeInterval);var n=parseInt(r.next.period);t&&(a.nextPeriod=n,a.awardWait=parseInt(r.waitTimeInterval),a.reloading=!1),a.periodText=n.toString(),a.nextPeriodNow=n,a.nextAwardWait=parseInt(r.waitTimeInterval),a.periodText.length<3&&(a.periodText=a.periodText.replace(/\d+/g,function(e){return"00".substr(e.length-1)+e})),console.log("距"+a.periodText+"期开奖"),i.emit("getAwardTimeObject_timerContainer",{currentPeriod:r.current.period,nextPeriod:a.periodText,time:a.formatTime(r.time),surplus:r.overPeriod,originTime:t?"":r.time}),e&&e(a.awardTimeCount)})},isReturnJson:function(e){return void 0==e?(l.awardType="other",!1):"history"==e||"javascript"==l.awardType},formatTime:function(e){if(e){if(-1==e.indexOf(" "))return e.replace(/\//g,"-");return e.split(" ")[0].replace(/\//g,"-")}return void console.error("formatDate: 参数不存在！")}}});